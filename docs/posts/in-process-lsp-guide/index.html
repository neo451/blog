<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zizhou Teng">
<meta name="dcterms.date" content="2025-11-27">

<title>A guide to building in-process LSP in neovim: Part 1 – zztopia</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-ba8d99e66f008d88a3e1af2a9d372bfe.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">zztopia</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/neo451"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">A guide to building in-process LSP in neovim: Part 1</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">neovim</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Zizhou Teng </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 27, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#why-in-process-lsp" id="toc-why-in-process-lsp" class="nav-link active" data-scroll-target="#why-in-process-lsp">Why in-process LSP?</a></li>
  <li><a href="#goal-of-this-guide" id="toc-goal-of-this-guide" class="nav-link" data-scroll-target="#goal-of-this-guide">Goal of this guide</a></li>
  <li><a href="#infrastructure" id="toc-infrastructure" class="nav-link" data-scroll-target="#infrastructure">Infrastructure</a></li>
  <li><a href="#initializing-the-client-and-server" id="toc-initializing-the-client-and-server" class="nav-link" data-scroll-target="#initializing-the-client-and-server">Initializing the client and server</a></li>
  <li><a href="#hover" id="toc-hover" class="nav-link" data-scroll-target="#hover">Hover</a></li>
  <li><a href="#definition-and-references" id="toc-definition-and-references" class="nav-link" data-scroll-target="#definition-and-references">Definition and References</a></li>
  <li><a href="#completion" id="toc-completion" class="nav-link" data-scroll-target="#completion">Completion</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="why-in-process-lsp" class="level2">
<h2 class="anchored" data-anchor-id="why-in-process-lsp">Why in-process LSP?</h2>
<p>I have spent quite some time turning most parts of the functionality of <a href="https://github.com/obsidian-nvim/obsidian.nvim">obsidian.nvim</a> into an in-process LSP, and many folks have asked me how it compares to an actual LSP process running outside of neovim, or just wanted to get a general idea of what it means, since there aren’t not many good guides out there.</p>
<p>Below are my usual answers, and I intend to use this post with a concrete example project to give you an idea of how it works and why I think it is my favorite “black magic” feature of neovim:</p>
<ul>
<li>You get neovim’s default LSP keymaps for free:
<ul>
<li>You get meaningful keymaps that most users are already using, and by default they are perfect keymaps to overload (expanded in <a href="#definition-and-references">Definition and References</a>)</li>
</ul></li>
<li>You get to leverage the vast ecosystem of plugins that enhance the LSP experience for free:
<ul>
<li>For example, <code>inc-rename.nvim</code> is just a better rename handler, and completion plugins like <code>blink.cmp</code> and <code>nvim-cmp</code> are essentially completion handlers, you don’t build integrations for all of these plugins with their APIs, you become the source of knowledge for them, thus being plugin agnostic</li>
</ul></li>
<li>You let neovim do the heavy lifting logic for you:
<ul>
<li>You pass data to neovim’s well maintained hanlders to do things like renaming symbols in your workspace (trust me it will get messy if you do it yourself).</li>
</ul></li>
<li>You get to “cheat” a bit than LSPs running as a system process:
<ul>
<li>They have to constantly keep negotiating with neovim about the document’s state, while you can just go <code>vim.api.nvim_buf_get_lines</code></li>
</ul></li>
</ul>
</section>
<section id="goal-of-this-guide" class="level2">
<h2 class="anchored" data-anchor-id="goal-of-this-guide">Goal of this guide</h2>
<p>I have been enjoying using <a href="https://github.com/archie-Judd/blink-cmp-words">blink-cmp-words</a>, which provides completion for words and synonyms when I write essays. However, I sometimes get frustrated for not being able to hover over a word and get what I had just seen in the documentation window when doing completion. So building it into an LSP is the perfect solution.</p>
<p>For the purpose of this guide, we will ignore all the details of actually querying the dictionary, and use various hacks and placeholders to get the idea across. I believe the eventual best solution would be using the same <code>WordNet</code> db approach that <code>blink-cmp-words</code> uses.</p>
<ul>
<li>The complete example project as a <a href="https://gist.github.com/neo451/13a9430955e5cb8b4b5a26c2f596f17c">gist</a></li>
<li>If you want to learn how “real” LSP servers work, see this <a href="https://www.youtube.com/watch?v=YsdlcQoHqPY">video by tj</a></li>
</ul>
</section>
<section id="infrastructure" class="level2">
<h2 class="anchored" data-anchor-id="infrastructure">Infrastructure</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@type</span><span class="co"> table</span><span class="kw">&lt;vim.lsp.protocol.Method</span><span class="ot">, fun(params: table, callback:fun(err: lsp.ResponseError?, result: any))</span><span class="kw">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">handlers</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">ms</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">lsp</span><span class="op">.</span><span class="va">protocol</span><span class="op">.</span><span class="va">Methods</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">buf</span><span class="co"> integer</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@return</span><span class="co"> integer? client_id</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> start_lsp<span class="op">(</span><span class="va">buf</span><span class="op">)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   <span class="co">---</span><span class="an">@type</span><span class="co"> vim.lsp.ClientConfig</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">client_cfg</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">name</span> <span class="op">=</span> <span class="st">"dict-lsp"</span><span class="op">,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">cmd</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>         <span class="cf">return</span> <span class="op">{</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">request</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span><span class="op">,</span> <span class="va">params</span><span class="op">,</span> <span class="va">callback</span><span class="op">)</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> <span class="va">handlers</span><span class="op">[</span><span class="va">method</span><span class="op">]</span> <span class="cf">then</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                  <span class="va">handlers</span><span class="op">[</span><span class="va">method</span><span class="op">](</span><span class="va">params</span><span class="op">,</span> <span class="va">callback</span><span class="op">)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>               <span class="cf">end</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>            <span class="va">notify</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span> <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>            <span class="va">is_closing</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span> <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            <span class="va">terminate</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span> <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>         <span class="op">}</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="va">vim</span><span class="op">.</span><span class="va">lsp</span><span class="op">.</span>start<span class="op">(</span><span class="va">client_cfg</span><span class="op">,</span> <span class="op">{</span> <span class="va">bufnr</span> <span class="op">=</span> <span class="va">buf</span><span class="op">,</span> <span class="va">silent</span> <span class="op">=</span> <span class="kw">false</span> <span class="op">})</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="va">vim</span><span class="op">.</span><span class="va">api</span><span class="op">.</span>nvim_create_autocmd<span class="op">(</span><span class="st">"FileType"</span><span class="op">,</span> <span class="op">{</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>   <span class="va">pattern</span> <span class="op">=</span> <span class="op">{</span> <span class="st">"markdown"</span><span class="op">,</span> <span class="st">"neorg"</span><span class="op">,</span> <span class="st">"org"</span><span class="op">,</span> <span class="st">"txt"</span> <span class="op">},</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>   <span class="va">callback</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">ev</span><span class="op">)</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>      start_lsp<span class="op">(</span><span class="va">ev</span><span class="op">.</span><span class="va">buf</span><span class="op">)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that in theory after <code>nvim-0.11</code> you could use <code>vim.lsp.config</code> which will be a bit more convenient, I just have not tried it and the improvements don’t concern the topic today.</p>
</div>
</div>
<p>The most important API to know is <a href="https://neovim.io/doc/user/lsp.html#vim.lsp.start()"><code>:h vim.lsp.start</code></a>, it takes <code>vim.lsp.ClientConfig</code> and the two fields that concern us at the moment are:</p>
<ul>
<li><code>name</code>: arbitrary name for the LSP client. Should be unique per language server.</li>
<li><code>cmd</code>: command string[] or function, and <code>cmd</code> in the case of in-process LSP will just be a function that returns a table of handlers, and we will only look into the <code>request</code> handler in this guide, as it handles most of the functionalities we think of when we think of LSP servers.</li>
</ul>
</section>
<section id="initializing-the-client-and-server" class="level2">
<h2 class="anchored" data-anchor-id="initializing-the-client-and-server">Initializing the client and server</h2>
<p>First time seeing the signature name <code>vim.lsp.ClientConfig</code> for those not familiar with neovim LSP might be somewhat confusing: weren’t we writing a server here? The answer is neovim spawns one LSP client per running server.</p>
<p>And <code>cmd</code> is the recipe for the client to spawn the right LSP server, in this case, we don’t need to to run a new process, we just registered a function (that returns a table of method handlers) in memory.</p>
<p>After spawning, the example above still will not work since our client and server have not negotiated a contract based on each other’s capabilities, usually this is a two way process, but since we are not an editor-agnostic server, we don’t really need to think about neovim’s client capabilities.</p>
<p>We only need neovim to know our server’s capabilities, which is done through responding to the <code>initialize</code> client request. Here’s a minimal example containing all the capabilities we will implement in this guide:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">chars</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">32</span><span class="op">,</span> <span class="dv">126</span> <span class="cf">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">table.insert</span><span class="op">(</span><span class="va">chars</span><span class="op">,</span> <span class="fu">string.char</span><span class="op">(</span><span class="va">i</span><span class="op">))</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@type</span><span class="co"> lsp.InitializeResult</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">initializeResult</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   <span class="va">capabilities</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">hoverProvider</span> <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">definitionProvider</span> <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">referencesProvider</span> <span class="op">=</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">completionProvider</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>         <span class="va">triggerCharacters</span> <span class="op">=</span> <span class="va">chars</span><span class="op">,</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">},</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>   <span class="op">},</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>   <span class="va">serverInfo</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">name</span> <span class="op">=</span> <span class="st">"dict-lsp"</span><span class="op">,</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">version</span> <span class="op">=</span> <span class="st">"0.0.1"</span><span class="op">,</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>   <span class="op">},</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="va">handlers</span><span class="op">[</span><span class="va">ms</span><span class="op">.</span><span class="va">initialize</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="cn">_</span><span class="op">,</span> <span class="va">callback</span><span class="op">)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>   callback<span class="op">(</span><span class="kw">nil</span><span class="op">,</span> <span class="va">initializeResult</span><span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>With this handler setup, you should be able to open a markdown buffer, run <code>checkhealth vim.lsp</code>, and see our <code>dict-lsp</code>.</p>
<pre><code>vim.lsp: Active Clients ~
- dict-lsp (id: 3)
  - Version: 0.0.1
  - Root directory: nil
  - Command: &lt;function @/home/n451/Plugins/dict-lsp.nvim//lua/dict-lsp/init.lua:93&gt;
  - Settings: {}
  - Attached buffers: 13</code></pre>
</section>
<section id="hover" class="level2">
<h2 class="anchored" data-anchor-id="hover">Hover</h2>
<p>Let’s try to implement what sets me out to write this guide, the hover.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">_</span><span class="co"> lsp.HoverParams</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">callback</span><span class="co"> fun(err?: lsp.ResponseError, result: lsp.Hover)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="va">handlers</span><span class="op">[</span><span class="va">ms</span><span class="op">.</span><span class="va">textDocument_hover</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="cn">_</span><span class="op">,</span> <span class="va">callback</span><span class="op">)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">word</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>expand<span class="op">(</span><span class="st">"&lt;cword&gt;"</span><span class="op">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">url_format</span> <span class="op">=</span> <span class="st">"https://api.dictionaryapi.dev/api/v2/entries/en/%s"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>   <span class="va">vim</span><span class="op">.</span>system<span class="op">(</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span> <span class="st">"curl"</span><span class="op">,</span> <span class="va">url_format</span><span class="op">:</span><span class="fu">format</span><span class="op">(</span><span class="va">word</span><span class="op">)</span> <span class="op">},</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">vim</span><span class="op">.</span>schedule_wrap<span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>         <span class="kw">local</span> <span class="va">contents</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> <span class="va">out</span><span class="op">.</span><span class="va">code</span> <span class="op">~=</span> <span class="dv">0</span> <span class="cf">then</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            <span class="va">contents</span> <span class="op">=</span> <span class="st">"word fetch failed"</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>         <span class="cf">else</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">local</span> <span class="va">ok</span><span class="op">,</span> <span class="va">decoded</span> <span class="op">=</span> <span class="fu">pcall</span><span class="op">(</span><span class="va">vim</span><span class="op">.</span><span class="va">json</span><span class="op">.</span><span class="va">decode</span><span class="op">,</span> <span class="va">out</span><span class="op">.</span><span class="va">stdout</span><span class="op">)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">ok</span> <span class="kw">and</span> <span class="va">decoded</span> <span class="kw">and</span> <span class="va">decoded</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="cf">then</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>               <span class="va">contents</span> <span class="op">=</span> <span class="va">decoded</span><span class="op">[</span><span class="dv">1</span><span class="op">].</span><span class="va">meanings</span><span class="op">[</span><span class="dv">1</span><span class="op">].</span><span class="va">definitions</span><span class="op">[</span><span class="dv">1</span><span class="op">].</span><span class="va">definition</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>               <span class="va">contents</span> <span class="op">=</span> <span class="va">decoded</span><span class="op">.</span><span class="va">message</span> <span class="co">-- this api gives a nice message if no result</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>         <span class="cf">end</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>         callback<span class="op">(</span><span class="kw">nil</span><span class="op">,</span> <span class="op">{</span> <span class="va">contents</span> <span class="op">=</span> <span class="va">contents</span> <span class="op">})</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">end</span><span class="op">)</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>   <span class="op">)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Isn’t it amazing that now you get hover windows on words?</p>
<p>Two points worth noting:</p>
<ol type="1">
<li>In a “real” LSP server, we will need to get the current file and current cursor position from the <code>params</code>, and then it will need to compare its internal document state and compute the current word, but we get to “cheat” by just calling <code>vim.fn.expand"&lt;cword&gt;"</code>, but I would suggest you don’t perform any actions that change the buffer and this is general principle for me when writing these in-process servers: we should think the document as mostly a read-only and immuntatble data, we only compute the data that is neccessary for neovim to performe actions.</li>
<li>I basically copied the implementation to fetch the <code>meaning</code> from the returned json string, from <a href="https://github.com/nvimtools/none-ls.nvim/blob/1917c86818b5e058f53c2ea0ad38fc57534d62fc/lua/null-ls/builtins/hover/dictionary.lua#L4">none-ls.nvim’s dictionary source</a>, there’s a even more powerful one to show you more detailed information about the word in <a href="https://github.com/lewis6991/hover.nvim/blob/3b49066e09e03e63be6d6f43ae2b8bcd58301f63/lua/hover/providers/dictionary.lua#L5">hover.nvim’s dictionary provider</a>, the later is pretty much a drag-in replacement.</li>
</ol>
</section>
<section id="definition-and-references" class="level2">
<h2 class="anchored" data-anchor-id="definition-and-references">Definition and References</h2>
<p>LSP-related concepts forms a good mental map to <em>restructure and conceptualize scattered pieces of actions</em>, for example in obsidian.nvim, I had a revelation that everything from a <code>tag</code> to all kinds of <code>links</code> the plugin supports can just be thought of as <code>symbols</code> in LSP world that can be performed actions upon, and the two most important actions are <code>goto definition</code> and <code>find references</code>. (in obsidian jargon, it is <code>linking</code> and <code>backlinking</code>), quite like the idea that you can do all sorts of <code>motions</code> on different <code>textobjects</code> in vim.</p>
<p>So applying a similar logic, we can think <code>goto definition</code> in dictionary land could mean just finding the meaning of the word, and <code>find references</code> means looking up synonyms.</p>
<p>My initial idea for a complete implementation will look up the definitions and references, and then write a formatted page of markdown describing the meaning for each of the word in a tmp file, then return a list of <code>lsp.Location</code> pointing to them.</p>
<p>But since we did not implement <code>WordNet</code> queries, and the free dictionary API used above doesn’t provide a mechanism to look up synonyms, I came up with a rather fun and creative hack that kind of bypasses neovim’s handler pattern:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="va">handlers</span><span class="op">[</span><span class="va">ms</span><span class="op">.</span><span class="va">textDocument_definition</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">url</span> <span class="op">=</span> <span class="st">"https://dictionary.cambridge.org/dictionary/english/%s"</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">word</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>expand<span class="op">(</span><span class="st">"&lt;cword&gt;"</span><span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">vim</span><span class="op">.</span><span class="va">ui</span><span class="op">.</span>open<span class="op">(</span><span class="fu">string.format</span><span class="op">(</span><span class="va">url</span><span class="op">,</span> <span class="va">word</span><span class="op">))</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="va">handlers</span><span class="op">[</span><span class="va">ms</span><span class="op">.</span><span class="va">textDocument_references</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">url</span> <span class="op">=</span> <span class="st">"https://dictionary.cambridge.org/thesaurus/%s"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">word</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>expand<span class="op">(</span><span class="st">"&lt;cword&gt;"</span><span class="op">)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>   <span class="va">vim</span><span class="op">.</span><span class="va">ui</span><span class="op">.</span>open<span class="op">(</span><span class="fu">string.format</span><span class="op">(</span><span class="va">url</span><span class="op">,</span> <span class="va">word</span><span class="op">))</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>But I do think this is even better than actually querying, at least to me browser would make more sense to display a definition of a word.</p>
<p>Some readers might ask if we did not use the <code>params</code> sent from client, and did not return anything to the client, instead, we only did an arbitrary side effect that is completely unrelated to LSP, what difference does it have compared to just binding the function to the keys like the following?</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="va">vim</span><span class="op">.</span><span class="va">keymap</span><span class="op">.</span>set<span class="op">(</span><span class="st">"n"</span><span class="op">,</span> <span class="st">"grr"</span><span class="op">,</span> <span class="kw">function</span><span class="op">()</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">url</span> <span class="op">=</span> <span class="st">"https://dictionary.cambridge.org/thesaurus/%s"</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">word</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>expand<span class="op">(</span><span class="st">"&lt;cword&gt;"</span><span class="op">)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">vim</span><span class="op">.</span><span class="va">ui</span><span class="op">.</span>open<span class="op">(</span><span class="fu">string.format</span><span class="op">(</span><span class="va">url</span><span class="op">,</span> <span class="va">word</span><span class="op">))</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>That leads us to the natural of “LSP keymaps” in neovim, in many ways they are special, many of them correspond to a <code>vim.lsp.buf</code> function, which will properly handle all the servers attached to one buffer and display results properly, for example multiple <code>hover</code> results will be shown together in the hover window, try making our little <code>dict-lsp</code> to also load in <code>lua</code>, and run some hovers if you have not seen multiple servers in action.</p>
<p>This nice feature makes “LSP keymaps” <strong>infinitely overloadable</strong>, you just add a server with the capability and corresponding handler, whereas the <code>vim.keymap.set</code> example will only ever run that one function in markdown.</p>
</section>
<section id="completion" class="level2">
<h2 class="anchored" data-anchor-id="completion">Completion</h2>
<p>Completion is, in my opinion, the ultimate prize to win in the journey of in-process LSP, once I land <a href="https://github.com/obsidian-nvim/obsidian.nvim/pull/474">lsp completion in obsidian.nvim</a>, I will be able to deleted thousands of lines of lines of completion engine specific code that are messy to maintain. It also serves as a pretty satisfying concluding case for our little guide.</p>
<p>The following is basically an adaptation of <a href="https://github.com/nvimtools/none-ls.nvim/blob/1917c86818b5e058f53c2ea0ad38fc57534d62fc/lua/null-ls/builtins/completion/spell.lua">none-ls’s spell source</a>. Funny story is I have seen more than one person posting on <code>r/neovim</code>, saying they get unwanted words in their completion list, because none-ls.nvim list this source as a default example, and many forgot they left it there.</p>
<p>The reason this source is not very useful is that it uses vim’s native <code>spellsuggest</code> function to complete the word. I actually happened to find this paragraph describing the difference between a spell file and a dictionary in the help file today <code>:h spell-file-format</code>:</p>
<blockquote class="blockquote">
<p>Note that we avoid the word “dictionary” here. That is because the goal of spell checking differs from writing a dictionary (as in the book). For spelling we need a list of words that are OK, thus should not be highlighted. Person and company names will not appear in a dictionary, but do appear in a word list. And some old words are rarely used while they are common misspellings. These do appear in a dictionary but not in a word list.</p>
</blockquote>
<p>As with all the cases above, we will need a capable local dictionary db or a paid dictionary API to really resolve this issue, but right now I think spell file approch is good enough for us, and I added fuzzy matching and filtering some unwanted cases to tidy up things a bit.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode lua code-with-copy"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">---Adapted from none-ls</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">---gets word to complete for use in completion sources</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">params</span><span class="co"> lsp.CompletionParams</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@return</span><span class="co"> string word_to_complete</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">get_word_to_complete</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">col</span> <span class="op">=</span> <span class="va">params</span><span class="op">.</span><span class="va">position</span><span class="op">.</span><span class="va">character</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">line</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">api</span><span class="op">.</span>nvim_get_current_line<span class="op">()</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">line_to_cursor</span> <span class="op">=</span> <span class="va">line</span><span class="op">:</span><span class="fu">sub</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="va">col</span><span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">regex</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span>regex<span class="op">(</span><span class="st">"</span><span class="sc">\\</span><span class="st">k*$"</span><span class="op">)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>   <span class="cf">return</span> <span class="va">line</span><span class="op">:</span><span class="fu">sub</span><span class="op">(</span><span class="va">regex</span><span class="op">:</span>match_str<span class="op">(</span><span class="va">line_to_cursor</span><span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="va">col</span><span class="op">)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">params</span><span class="co"> lsp.CompletionParams</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">---</span><span class="an">@param</span><span class="co"> </span><span class="cv">callback</span><span class="co"> fun(err?: lsp.ResponseError, result: lsp.CompletionItem[])</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="va">handlers</span><span class="op">[</span><span class="va">ms</span><span class="op">.</span><span class="va">textDocument_completion</span><span class="op">]</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">params</span><span class="op">,</span> <span class="va">callback</span><span class="op">)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">word</span> <span class="op">=</span> get_word_to_complete<span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">get_candidates</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">entries</span><span class="op">)</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">entries</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>matchfuzzy<span class="op">(</span><span class="va">entries</span><span class="op">,</span> <span class="va">word</span><span class="op">,</span> <span class="op">{</span> <span class="va">limit</span> <span class="op">=</span> <span class="dv">7</span> <span class="op">})</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">local</span> <span class="va">items</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="va">k</span><span class="op">,</span> <span class="va">v</span> <span class="kw">in</span> <span class="fu">ipairs</span><span class="op">(</span><span class="va">entries</span><span class="op">)</span> <span class="cf">do</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>         <span class="va">items</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span> <span class="va">label</span> <span class="op">=</span> <span class="va">v</span><span class="op">,</span> <span class="va">kind</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span><span class="va">lsp</span><span class="op">.</span><span class="va">protocol</span><span class="op">.</span><span class="va">CompletionItemKind</span><span class="op">[</span><span class="st">"Text"</span><span class="op">]</span> <span class="op">}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="va">vim</span><span class="op">.</span><span class="va">items</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>   <span class="kw">local</span> <span class="va">candidates</span> <span class="op">=</span> get_candidates<span class="op">(</span><span class="va">vim</span><span class="op">.</span><span class="va">fn</span><span class="op">.</span>spellsuggest<span class="op">(</span><span class="va">word</span><span class="op">))</span> <span class="co">-- a real implementation queries a dictionary here</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>   <span class="va">candidates</span> <span class="op">=</span> <span class="va">vim</span><span class="op">.</span>tbl_filter<span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">candidate</span><span class="op">)</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="va">candidate</span><span class="op">.</span><span class="va">label</span><span class="op">:</span><span class="fu">find</span><span class="op">(</span><span class="st">"[ ']"</span><span class="op">)</span> <span class="op">==</span> <span class="kw">nil</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>   <span class="kw">end</span><span class="op">,</span> <span class="va">candidates</span><span class="op">)</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>   callback<span class="op">(</span><span class="kw">nil</span><span class="op">,</span> <span class="op">{</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>      <span class="va">items</span> <span class="op">=</span> <span class="va">candidates</span><span class="op">,</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>      <span class="va">isIncomplete</span> <span class="op">=</span> <span class="op">#</span><span class="va">candidates</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>   <span class="op">})</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>There you go, have fun exploring. I actually have a lot more ideas that I want to implement, but I will leave it here so that I can post it before I procrastinate over perfectionism. Maybe will write a part 2 if I have enough good ideas.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/neo451\.github\.io\/blog\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>